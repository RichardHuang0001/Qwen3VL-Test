# QWen-VL äº¤é€šç—…å®³æ£€æµ‹ç§‘ç ”é¡¹ç›®
## ğŸ“– é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºé˜¿é‡Œäº‘**QWen-VLè§†è§‰è¯­è¨€æ¨¡å‹**çš„äº¤é€šåŸºç¡€è®¾æ–½ç—…å®³æ£€æµ‹ç³»ç»Ÿï¼Œä¸“æ³¨äºè‡ªåŠ¨è¯†åˆ«å’Œå®šä½é“è·¯è£‚ç¼ã€å‘æ´ç­‰ç—…å®³ã€‚é¡¹ç›®é‡‡ç”¨æ‰¹é‡æ¨ç†æ–¹å¼ï¼Œæ”¯æŒå¤§è§„æ¨¡å›¾ç‰‡çš„è‡ªåŠ¨åŒ–æ£€æµ‹ä¸å¯è§†åŒ–åˆ†æã€‚

### æ ¸å¿ƒåŠŸèƒ½
- âœ… å›¾ç‰‡é¢„å¤„ç†ä¸Base64ç¼–ç 
- âœ… XMLæ ‡æ³¨æ•°æ®æ¢ç´¢ä¸ç»Ÿè®¡
- âœ… æ•°æ®è´¨é‡æ£€æŸ¥ï¼ˆå›¾ç‰‡å¤§å°éªŒè¯ï¼‰
- âœ… æ‰¹é‡APIè¯·æ±‚æ„å»º
- âœ… æ–­ç‚¹ç»­ä¼ çš„æ‰¹é‡æ¨ç†ä»»åŠ¡æäº¤
- âœ… æ£€æµ‹ç»“æœå¯è§†åŒ–ï¼ˆå¸¦è¾¹ç•Œæ¡†æ ‡æ³¨ï¼‰

---

## ğŸ› ï¸ ç¯å¢ƒé…ç½®

### 1. ç³»ç»Ÿè¦æ±‚
- Python 3.8+
- macOS / Linux / Windows

### 2. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

**ä¾èµ–åŒ…è¯´æ˜ï¼š**
- `dashscope`ï¼šé˜¿é‡Œäº‘DashScope API SDK
- `opencv-python`ï¼šå›¾åƒå¤„ç†ä¸å¯è§†åŒ–
- `pyyaml`ï¼šé…ç½®æ–‡ä»¶è§£æ
- `openai`ï¼šOpenAIå…¼å®¹æ¥å£ï¼ˆç”¨äºæ‰¹é‡APIï¼‰

### 3. é…ç½®APIå¯†é’¥

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `config.yaml` æ–‡ä»¶ï¼š

```yaml
# APIé…ç½®
api_key: "sk-your-aliyun-api-key-here"  # æ›¿æ¢ä¸ºä½ çš„é˜¿é‡Œäº‘API Key
model_name: "qwen-vl-plus"

# æ•°æ®è·¯å¾„é…ç½®
data:
  raw_dir: "data/raw"              # åŸå§‹å›¾ç‰‡å’ŒXMLæ ‡æ³¨å­˜æ”¾ç›®å½•
  processed_dir: "data/processed"  # é¢„å¤„ç†åçš„æ•°æ®å­˜æ”¾ç›®å½•

# ç»“æœè·¯å¾„é…ç½®
results:
  output_dir: "results"            # APIç»“æœå’Œå¯è§†åŒ–è¾“å‡ºç›®å½•
```

**è·å–API Keyï¼š**
1. è®¿é—® [é˜¿é‡Œäº‘DashScopeæ§åˆ¶å°](https://dashscope.console.aliyun.com/)
2. æ³¨å†Œ/ç™»å½•è´¦å·
3. åˆ›å»ºAPI Keyå¹¶å¤åˆ¶åˆ°é…ç½®æ–‡ä»¶

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
Qwen3VL-Test/
â”œâ”€â”€ README.md                      # é¡¹ç›®è¯´æ˜æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â”œâ”€â”€ requirements.txt               # Pythonä¾èµ–åˆ—è¡¨
â”œâ”€â”€ config.yaml                    # é…ç½®æ–‡ä»¶ï¼ˆéœ€æ‰‹åŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ raw/                       # åŸå§‹æ•°æ®ç›®å½•ï¼ˆç”¨æˆ·æä¾›ï¼‰
â”‚   â”‚   â”œâ”€â”€ D00_cracks/           # ç¤ºä¾‹ï¼šè£‚ç¼ç±»åˆ«å­ç›®å½•
â”‚   â”‚   â”‚   â”œâ”€â”€ image_001.jpg
â”‚   â”‚   â”‚   â”œâ”€â”€ image_001.xml     # Pascal VOCæ ¼å¼æ ‡æ³¨
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ processed/                 # é¢„å¤„ç†è¾“å‡ºç›®å½•
â”‚       â”œâ”€â”€ preprocessed_images.json    # Base64ç¼–ç åçš„å›¾ç‰‡
â”‚       â””â”€â”€ batch_tasks_input.jsonl     # æ‰¹é‡APIè¯·æ±‚æ–‡ä»¶
â”œâ”€â”€ results/
â”‚   â”œâ”€â”€ api_raw_results_YYYYMMDD_HHMMSS.jsonl  # APIåŸå§‹ç»“æœ
â”‚   â”œâ”€â”€ .job_status.json                       # ä»»åŠ¡çŠ¶æ€ç¼“å­˜
â”‚   â””â”€â”€ visualizations/                        # å¯è§†åŒ–ç»“æœ
â”‚       â””â”€â”€ [å­ç›®å½•ç»“æ„ä¸rawç›¸åŒ]
â””â”€â”€ src/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ data/                      # æ•°æ®å¤„ç†æ¨¡å—
    â”‚   â”œâ”€â”€ preprocess.py          # å›¾ç‰‡é¢„å¤„ç†ï¼ˆBase64ç¼–ç ï¼‰
    â”‚   â”œâ”€â”€ explore_annotations.py # XMLæ ‡æ³¨æ¢ç´¢ç»Ÿè®¡
    â”‚   â””â”€â”€ check_data.py          # æ•°æ®è´¨é‡æ£€æŸ¥
    â”œâ”€â”€ api/                       # APIè°ƒç”¨æ¨¡å—
    â”‚   â”œâ”€â”€ build_batch_request.py # æ„å»ºæ‰¹é‡è¯·æ±‚
    â”‚   â””â”€â”€ submit_batch_job.py    # æäº¤å’Œç®¡ç†æ‰¹é‡ä»»åŠ¡
    â””â”€â”€ analysis/                  # ç»“æœåˆ†ææ¨¡å—
        â””â”€â”€ visualize_results.py   # ç»“æœå¯è§†åŒ–
```

---

## ğŸš€ å®Œæ•´å·¥ä½œæµç¨‹

### æ­¥éª¤ 0ï¼šå‡†å¤‡æ•°æ®é›†

å°†ä½ çš„å›¾ç‰‡æ•°æ®é›†æ”¾å…¥ `data/raw/` ç›®å½•ï¼š

```bash
mkdir -p data/raw
# å°†å›¾ç‰‡å’ŒXMLæ ‡æ³¨æ–‡ä»¶å¤åˆ¶åˆ° data/raw/ ç›®å½•
# æ”¯æŒå­ç›®å½•ç»“æ„ï¼Œä¾‹å¦‚ï¼š
# data/raw/D00_cracks/image_001.jpg
# data/raw/D00_cracks/image_001.xml
```

**æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ï¼š** `.jpg`, `.jpeg`, `.png`  
**æ ‡æ³¨æ ¼å¼ï¼š** Pascal VOC XMLï¼ˆå¯é€‰ï¼Œç”¨äºæ•°æ®æ¢ç´¢ï¼‰

---

### æ­¥éª¤ 1ï¼šæ¢ç´¢æ•°æ®é›†ï¼ˆå¯é€‰ï¼‰

**ç›®çš„ï¼š** ç»Ÿè®¡XMLæ ‡æ³¨ä¸­çš„ç—…å®³ç±»åˆ«åˆ†å¸ƒï¼Œäº†è§£æ•°æ®é›†æ„æˆã€‚

```bash
python src/data/explore_annotations.py
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
--- å¯åŠ¨æ•°æ®é›†(XML)æ¢ç´¢è„šæœ¬ ---
å°†æœç´¢ç›®å½•: /path/to/data/raw

[ä¿¡æ¯] æ‰¾åˆ°äº† 150 ä¸ª XML æ ‡æ³¨æ–‡ä»¶ã€‚å¼€å§‹è§£æ...

--- æ¢ç´¢å®Œæ¯•ï¼šæ•°æ®é›†ç»Ÿè®¡æŠ¥å‘Š ---
  - æ€»è®¡ XML æ–‡ä»¶æ•°: 150
  - æ€»è®¡ <object> æ ‡æ³¨æ•°: 320
  - æ€»è®¡ å”¯ä¸€ç±»åˆ«æ•°: 4

ğŸ“Š ç±»åˆ«åˆ†å¸ƒ (æŒ‰æ•°é‡æ’åº):
  - longitudinal_crack  : 120 ä¸ª
  - transverse_crack    : 85 ä¸ª
  - pothole             : 80 ä¸ª
  - alligator_crack     : 35 ä¸ª

--- [!!] ç§‘ç ”å»ºè®® ---
æ‚¨åœ¨ `data/raw/` æ•°æ®é›†ä¸­çš„çœŸå®ç±»åˆ«æ˜¯ï¼š
  ['longitudinal_crack', 'transverse_crack', 'pothole', 'alligator_crack']

åœ¨æ‚¨ä¸‹ä¸€æ¬¡å®éªŒä¸­ï¼Œæ‚¨ *å¿…é¡»* æ›´æ–°
`src/api/build_batch_request.py` è„šæœ¬ä¸­çš„ Promptï¼Œ
è®©æ¨¡å‹å»è¯†åˆ« *è¿™äº›* ç±»åˆ«, è€Œä¸æ˜¯åªå¯»æ‰¾ 'crack'ã€‚
```

---

### æ­¥éª¤ 2ï¼šé¢„å¤„ç†å›¾ç‰‡ï¼ˆBase64ç¼–ç ï¼‰

**ç›®çš„ï¼š** å°†æ‰€æœ‰å›¾ç‰‡ç¼–ç ä¸ºBase64æ ¼å¼ï¼Œå‡†å¤‡å‘é€ç»™APIã€‚

```bash
python src/data/preprocess.py
```

**å¤„ç†è¿‡ç¨‹ï¼š**
1. é€’å½’æ‰«æ `data/raw/` ç›®å½•ä¸‹çš„æ‰€æœ‰å›¾ç‰‡
2. å°†æ¯å¼ å›¾ç‰‡ç¼–ç ä¸ºBase64 Data URL
3. ä¿å­˜åˆ° `data/processed/preprocessed_images.json`

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
--- å¼€å§‹è½»é‡çº§é¢„å¤„ç† (ä»…Base64ç¼–ç ) ---
è¾“å…¥ç›®å½•: /path/to/data/raw
è¾“å‡ºæ–‡ä»¶: /path/to/data/processed/preprocessed_images.json

æ‰¾åˆ°äº† 150 å¼ å›¾ç‰‡ã€‚å¼€å§‹è¿›è¡ŒBase64ç¼–ç ...
ç¼–ç ä¸­: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 150/150 [00:05<00:00, 28.50it/s]

ç¼–ç å®Œæˆã€‚æ­£åœ¨å°†ç»“æœå†™å…¥ /path/to/data/processed/preprocessed_images.json ...

--- é¢„å¤„ç†å®Œæ¯• ---
æˆåŠŸï¼å·²å°† 150 å¼ å›¾ç‰‡çš„Base64æ•°æ®å­˜å…¥ preprocessed_images.json
è¾“å‡ºæ–‡ä»¶æ€»å¤§å°: 45.32 MB
```

---

### æ­¥éª¤ 3ï¼šæ£€æŸ¥æ•°æ®è´¨é‡ï¼ˆæ¨èï¼‰

**ç›®çš„ï¼š** æ£€æŸ¥æ¯å¼ å›¾ç‰‡çš„å¤§å°ï¼Œç¡®ä¿ä¸è¶…è¿‡APIè¯·æ±‚é™åˆ¶ï¼ˆ6MBï¼‰ã€‚

```bash
python src/data/check_data.py
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
--- å¼€å§‹æ•°æ®æ£€æŸ¥ (æ£€æŸ¥å•å¼ å›¾ç‰‡å¤§å°) ---
æ­£åœ¨æ£€æŸ¥æ–‡ä»¶: /path/to/data/processed/preprocessed_images.json
æ£€æŸ¥æ ‡å‡†ï¼šå•å¼ å›¾ç‰‡ä¼°ç®—è¯·æ±‚å¤§å°æ˜¯å¦ > 6.0 MB

å·²åŠ è½½ 150 å¼ å›¾ç‰‡çš„Base64æ•°æ®ã€‚å¼€å§‹åˆ†æ...

--- æ£€æŸ¥å®Œæ¯• ---
ğŸ“Š ç»Ÿè®¡æ€»è§ˆï¼š
  - æ€»è®¡å›¾ç‰‡æ•°: 150
  - å¹³å‡å¤§å°: 0.30 MB
  - (æœ€å¤§) D00_cracks/image_089.jpg (å¤§å°: 1.25 MB)
  - (æœ€å°) D01_potholes/image_012.jpg (å¤§å°: 0.15 MB)

ğŸš¨ é£é™©æŠ¥å‘Š (é˜ˆå€¼ = 6.0 MB)ï¼š
  - (å¥½æ¶ˆæ¯) æ‰€æœ‰ 150 å¼ å›¾ç‰‡çš„ä¼°ç®—è¯·æ±‚å¤§å°å‡ < 6.0 MBã€‚
  - é£é™©ä½ã€‚å¯ä»¥å®‰å…¨è¿›å…¥ä¸‹ä¸€æ­¥ã€‚
```

**å¦‚æœå‘ç°è¶…å¤§å›¾ç‰‡ï¼š**
- å»ºè®®å‹ç¼©å›¾ç‰‡åˆ†è¾¨ç‡åé‡æ–°è¿è¡Œæ­¥éª¤2

---

### æ­¥éª¤ 4ï¼šæ„å»ºæ‰¹é‡APIè¯·æ±‚

**ç›®çš„ï¼š** ä¸ºæ¯å¼ å›¾ç‰‡ç”ŸæˆAPIè¯·æ±‚ï¼Œæ‰“åŒ…æˆæ‰¹é‡ä»»åŠ¡æ–‡ä»¶ã€‚

```bash
python src/api/build_batch_request.py
```

**å¤„ç†è¿‡ç¨‹ï¼š**
1. è¯»å– `preprocessed_images.json`
2. ä¸ºæ¯å¼ å›¾ç‰‡æ„å»ºç»“æ„åŒ–Promptï¼ˆè¦æ±‚æ¨¡å‹è¿”å›ç›¸å¯¹åæ ‡ï¼‰
3. ç”Ÿæˆç¬¦åˆOpenAIæ‰¹é‡APIæ ¼å¼çš„JSONLæ–‡ä»¶
4. ä¿å­˜åˆ° `data/processed/batch_tasks_input.jsonl`

**Promptè®¾è®¡ï¼š**
- è¦æ±‚æ¨¡å‹è¯†åˆ«ç—…å®³ç±»å‹
- æ£€æµ‹æ‰€æœ‰è£‚ç¼å®ä¾‹
- è¿”å›**ç›¸å¯¹åæ ‡**ï¼ˆ0.0-1.0ï¼‰çš„è¾¹ç•Œæ¡†

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
--- å¼€å§‹æ„å»ºæ‰¹é‡APIè¯·æ±‚æ–‡ä»¶ (V2 - ç›¸å¯¹åæ ‡ç‰ˆ) ---
è¾“å…¥æ–‡ä»¶: /path/to/data/processed/preprocessed_images.json
è¾“å‡ºæ–‡ä»¶: /path/to/data/processed/batch_tasks_input.jsonl
ä½¿ç”¨æ¨¡å‹: qwen-vl-plus

å·²åŠ è½½ 150 å¼ å›¾ç‰‡çš„Base64æ•°æ®ã€‚å¼€å§‹å°è£…Prompt...
å°è£…è¯·æ±‚: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 150/150 [00:02<00:00, 65.32it/s]

--- æ„å»ºå®Œæ¯• ---
æˆåŠŸï¼å·²å°† 150 ä¸ªAPIä»»åŠ¡å†™å…¥ batch_tasks_input.jsonl

ä¸‹ä¸€æ­¥ï¼šè¯·è¿è¡Œ src/api/submit_batch_job.py æ¥æäº¤æ‚¨çš„å®éªŒã€‚
```

---

### æ­¥éª¤ 5ï¼šæäº¤æ‰¹é‡æ¨ç†ä»»åŠ¡

**ç›®çš„ï¼š** ä¸Šä¼ ä»»åŠ¡åˆ°é˜¿é‡Œäº‘ï¼Œå¯åŠ¨æ‰¹é‡æ¨ç†ï¼Œè‡ªåŠ¨è½®è¯¢å¹¶ä¸‹è½½ç»“æœã€‚

```bash
python src/api/submit_batch_job.py
```

**é¦–æ¬¡è¿è¡Œæµç¨‹ï¼š**
1. ä¸Šä¼  `batch_tasks_input.jsonl` åˆ°é˜¿é‡Œäº‘
2. åˆ›å»ºæ‰¹é‡æ¨ç†ä»»åŠ¡ï¼ˆè·å¾—Job IDï¼‰
3. ä¿å­˜ä»»åŠ¡çŠ¶æ€åˆ° `.job_status.json`ï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰
4. æ¯30ç§’è½®è¯¢ä»»åŠ¡çŠ¶æ€
5. ä»»åŠ¡å®Œæˆåè‡ªåŠ¨ä¸‹è½½ç»“æœ
6. ä¿å­˜ç»“æœåˆ° `results/api_raw_results_YYYYMMDD_HHMMSS.jsonl`

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
--- å¯åŠ¨æ‰¹é‡æ¨ç†ä»»åŠ¡æäº¤è„šæœ¬ (v3.1 - å¸¦æ—¶é—´æˆ³ç‰ˆ) ---

[æ–°ä»»åŠ¡] æœªæ‰¾åˆ°ç¼“å­˜ä»»åŠ¡ã€‚å°†åˆ›å»ºä¸€ä¸ªæ–°ä»»åŠ¡ã€‚
è­¦å‘Šï¼šæ­¤æ“ä½œå³å°†æ¶ˆè€—APIé¢åº¦ã€‚
  > æœ¬æ¬¡è¿è¡Œçš„ç»“æœå°†ä¿å­˜åˆ°: api_raw_results_20260104_143022.jsonl
  > æ­¥éª¤ 1/3: æ­£åœ¨ä¸Šä¼ ä»»åŠ¡æ–‡ä»¶...
  > æ–‡ä»¶ä¸Šä¼ æˆåŠŸã€‚File ID: file-abc123xyz
  > æ­¥éª¤ 2/3: æ­£åœ¨åˆ›å»ºæ‰¹é‡æ¨ç†ä»»åŠ¡...
  > ä»»åŠ¡åˆ›å»ºæˆåŠŸã€‚Job ID: batch-def456uvw
  > æ­¥éª¤ 3/3: æ­£åœ¨å°† Job ID å’Œæ–‡ä»¶åå†™å…¥ç¼“å­˜ .job_status.json ...
  > ç¼“å­˜å†™å…¥æˆåŠŸã€‚

[è½®è¯¢] å¼€å§‹ç›‘æ§ Job ID: batch-def456uvw (æ¯30ç§’æŸ¥è¯¢ä¸€æ¬¡)
  > 2026-01-04 14:30:52 - å½“å‰çŠ¶æ€: validating
  > 2026-01-04 14:31:22 - å½“å‰çŠ¶æ€: in_progress
  > 2026-01-04 14:31:52 - å½“å‰çŠ¶æ€: in_progress
  ...
  > 2026-01-04 14:45:22 - å½“å‰çŠ¶æ€: completed

[æˆåŠŸ] ä»»åŠ¡å·²æˆåŠŸå®Œæˆï¼

[ä¸‹è½½] æ­£åœ¨ä¸‹è½½åŸå§‹ç»“æœæ–‡ä»¶...
åŸå§‹ç»“æœæ–‡ä»¶ä¸‹è½½æˆåŠŸï¼å·²ä¿å­˜åˆ°:
/path/to/results/api_raw_results_20260104_143022.jsonl

[æ¸…ç†] ä»»åŠ¡å·²æˆåŠŸä¸‹è½½ï¼Œæ­£åœ¨æ¸…ç†ç¼“å­˜...
ç¼“å­˜æ–‡ä»¶ .job_status.json å·²åˆ é™¤ã€‚

--- å®Œæ•´å·¥ä½œæµæ‰§è¡Œå®Œæ¯• ---
```

**æ–­ç‚¹ç»­ä¼ åŠŸèƒ½ï¼š**
å¦‚æœè„šæœ¬è¢«ä¸­æ–­ï¼ˆCtrl+Cæˆ–ç½‘ç»œé”™è¯¯ï¼‰ï¼Œå†æ¬¡è¿è¡Œå³å¯è‡ªåŠ¨æ¢å¤ï¼š
```bash
python src/api/submit_batch_job.py
# è¾“å‡ºï¼š[æ¢å¤] æ‰¾åˆ°äº†ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¼“å­˜ä»»åŠ¡: batch-def456uvw
```

---

### æ­¥éª¤ 6ï¼šå¯è§†åŒ–æ£€æµ‹ç»“æœ

**ç›®çš„ï¼š** åœ¨åŸå›¾ä¸Šç»˜åˆ¶æ¨¡å‹æ£€æµ‹çš„è¾¹ç•Œæ¡†å’Œæ ‡ç­¾ã€‚

```bash
python src/analysis/visualize_results.py
```

**å¤„ç†è¿‡ç¨‹ï¼š**
1. è‡ªåŠ¨æ‰¾åˆ°æœ€æ–°çš„ç»“æœæ–‡ä»¶ï¼ˆ`api_raw_results_*.jsonl`ï¼‰
2. è§£ææ¨¡å‹è¿”å›çš„JSON
3. å°†ç›¸å¯¹åæ ‡è½¬æ¢ä¸ºåƒç´ åæ ‡
4. ä½¿ç”¨OpenCVç»˜åˆ¶ï¼š
   - ç—…å®³ç±»å‹æ ‡ç­¾ï¼ˆçº¢è‰²æ–‡å­—ï¼‰
   - æ£€æµ‹æ¡†ï¼ˆç»¿è‰²çŸ©å½¢ï¼‰
   - ç±»åˆ«æ ‡ç­¾ï¼ˆç»¿è‰²æ–‡å­—ï¼‰
5. ä¿å­˜åˆ° `results/visualizations/`ï¼ˆä¿ç•™åŸå§‹å­ç›®å½•ç»“æ„ï¼‰

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
--- å¯åŠ¨ç»“æœå¯è§†åŒ–è„šæœ¬ ---

[ä¿¡æ¯] æ­£åœ¨å¤„ç†æœ€æ–°çš„ç»“æœæ–‡ä»¶:
  > api_raw_results_20260104_143022.jsonl
[ä¿¡æ¯] å¯è§†åŒ–ç»“æœå°†ä¿å­˜åˆ°:
  > /path/to/results/visualizations
  > å…±æœ‰ 150 æ¡ç»“æœéœ€è¦å¤„ç†ã€‚
ç”Ÿæˆå¯è§†åŒ–: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 150/150 [00:12<00:00, 12.15it/s]

--- å¯è§†åŒ–å®Œæ¯• ---
æ‰€æœ‰å›¾ç‰‡å·²ä¿å­˜åˆ° /path/to/results/visualizations
```

**æŸ¥çœ‹ç»“æœï¼š**
```bash
# æ‰“å¼€å¯è§†åŒ–ç»“æœç›®å½•
open results/visualizations/
```

---

## ğŸ“Š ç»“æœæ–‡ä»¶è¯´æ˜

### 1. APIåŸå§‹ç»“æœæ–‡ä»¶
**è·¯å¾„ï¼š** `results/api_raw_results_YYYYMMDD_HHMMSS.jsonl`

**æ ¼å¼ï¼š** æ¯è¡Œä¸€ä¸ªJSONå¯¹è±¡

```json
{
  "custom_id": "D00_cracks/image_001",
  "response": {
    "body": {
      "choices": [{
        "message": {
          "content": "```json\n{\"defect_type\": \"longitudinal_crack\", \"detections\": [{\"label\": \"crack\", \"box_2d\": [0.23, 0.15, 0.78, 0.92]}]}\n```"
        }
      }]
    }
  }
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `custom_id`ï¼šå›¾ç‰‡IDï¼ˆç›¸å¯¹äº `data/raw/` çš„è·¯å¾„ï¼Œæ— æ‰©å±•åï¼‰
- `defect_type`ï¼šæ¨¡å‹è¯†åˆ«çš„ç—…å®³ç±»å‹
- `detections`ï¼šæ£€æµ‹ç»“æœåˆ—è¡¨
- `box_2d`ï¼šè¾¹ç•Œæ¡†ç›¸å¯¹åæ ‡ `[ymin, xmin, ymax, xmax]`ï¼ˆèŒƒå›´0.0-1.0ï¼‰

### 2. å¯è§†åŒ–ç»“æœ
**è·¯å¾„ï¼š** `results/visualizations/[å­ç›®å½•]/image_*.jpg`

æ¯å¼ å›¾ç‰‡ä¸Šç»˜åˆ¶äº†ï¼š
- **çº¢è‰²æ–‡å­—**ï¼šç—…å®³ç±»å‹ï¼ˆå·¦ä¸Šè§’ï¼‰
- **ç»¿è‰²çŸ©å½¢**ï¼šæ£€æµ‹æ¡†
- **ç»¿è‰²æ–‡å­—**ï¼šç±»åˆ«æ ‡ç­¾ï¼ˆæ¡†ä¸Šæ–¹ï¼‰

---

## âš™ï¸ é«˜çº§é…ç½®

### ä¿®æ”¹Promptï¼ˆæ ¹æ®æ•°æ®é›†å®šåˆ¶ï¼‰

ç¼–è¾‘ `src/api/build_batch_request.py` ä¸­çš„ `create_structured_prompt()` å‡½æ•°ï¼š

```python
def create_structured_prompt(base64_data_url: str, model_name: str) -> dict:
    prompt_text = (
        "è¯·ä»”ç»†æ£€æŸ¥è¿™å¼ å›¾ç‰‡ã€‚\n"
        "1. é¦–å…ˆï¼Œè¯†åˆ«è¿™å¼ å›¾ç‰‡ä¸­åŒ…å«çš„ä¸»è¦ç—…å®³ç±»å‹ï¼ˆä¾‹å¦‚ï¼šçºµå‘è£‚ç¼ã€æ¨ªå‘è£‚ç¼ã€ç½‘çŠ¶è£‚ç¼ã€å‘æ´ã€é”ˆè¿¹ã€æˆ–æ— ç—…å®³ï¼‰ã€‚\n"
        "2. ç„¶åï¼Œæ‰¾å‡ºå›¾ä¸­æ‰€æœ‰çš„'è£‚ç¼'å®ä¾‹ã€‚\n"
        # ... æ ¹æ®ä½ çš„æ•°æ®é›†ä¿®æ”¹è¿™é‡Œ
    )
```

**å»ºè®®ï¼š** è¿è¡Œ `explore_annotations.py` åï¼Œæ ¹æ®å®é™…ç±»åˆ«æ›´æ–°Promptã€‚

### æ›´æ”¹æ¨¡å‹

åœ¨ `config.yaml` ä¸­ä¿®æ”¹ï¼š
```yaml
model_name: "qwen-vl-max"  # æ›´é«˜ç²¾åº¦æ¨¡å‹
# æˆ–
model_name: "qwen-vl-plus"  # å¹³è¡¡æ€§èƒ½ä¸æˆæœ¬
```

---

## â“ å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### Q1: æç¤º"API Key æœªé…ç½®"ï¼Ÿ
**A:** ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºäº† `config.yaml`ï¼Œå¹¶å¡«å†™äº†æ­£ç¡®çš„API Keyã€‚

### Q2: ä»»åŠ¡ä¸€ç›´å¤„äº `in_progress` çŠ¶æ€ï¼Ÿ
**A:** æ‰¹é‡ä»»åŠ¡éœ€è¦æ—¶é—´å¤„ç†ï¼Œé€šå¸¸å‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶ä¸ç­‰ã€‚è„šæœ¬ä¼šè‡ªåŠ¨ç­‰å¾…ï¼Œè¯·ä¿æŒè¿è¡Œæˆ–ä½¿ç”¨æ–­ç‚¹ç»­ä¼ ã€‚

### Q3: ä¸­æ–­åå¦‚ä½•æ¢å¤ä»»åŠ¡ï¼Ÿ
**A:** ç›´æ¥é‡æ–°è¿è¡Œ `python src/api/submit_batch_job.py`ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹ `.job_status.json` å¹¶æ¢å¤ã€‚

### Q4: å¯è§†åŒ–ç»“æœä¸­æ²¡æœ‰æ£€æµ‹æ¡†ï¼Ÿ
**A:** å¯èƒ½åŸå› ï¼š
- æ¨¡å‹æœªæ£€æµ‹åˆ°ç—…å®³ï¼ˆè¿”å›ç©ºçš„ `detections`ï¼‰
- Promptè®¾è®¡éœ€è¦ä¼˜åŒ–
- å›¾ç‰‡è´¨é‡è¿‡ä½

### Q5: å¦‚ä½•å¤„ç†è¶…å¤§å›¾ç‰‡ï¼ˆ>6MBï¼‰ï¼Ÿ
**A:** ä½¿ç”¨å›¾ç‰‡å‹ç¼©å·¥å…·é™ä½åˆ†è¾¨ç‡ï¼š
```bash
# ç¤ºä¾‹ï¼šä½¿ç”¨ImageMagickå‹ç¼©
mogrify -resize 50% -quality 85 data/raw/**/*.jpg
```

### Q6: å¦‚ä½•æ‰¹é‡å¤„ç†å¤šä¸ªå®éªŒï¼Ÿ
**A:** æ¯æ¬¡å®éªŒç»“æœæ–‡ä»¶å¸¦æ—¶é—´æˆ³ï¼Œä¸ä¼šè¦†ç›–ã€‚å¯è¿ç»­è¿è¡Œå¤šæ¬¡ï¼š
```bash
# å®éªŒ1
python src/api/build_batch_request.py
python src/api/submit_batch_job.py
python src/analysis/visualize_results.py

# ä¿®æ”¹Promptæˆ–é…ç½®åï¼Œå®éªŒ2
python src/api/build_batch_request.py
python src/api/submit_batch_job.py
python src/analysis/visualize_results.py
```

---

## ğŸ“ å¼•ç”¨ä¸è®¸å¯

æœ¬é¡¹ç›®åŸºäºé˜¿é‡Œäº‘DashScopeå¹³å°çš„QWen-VLæ¨¡å‹ã€‚

**ç›¸å…³æ–‡æ¡£ï¼š**
- [DashScopeå®˜æ–¹æ–‡æ¡£](https://help.aliyun.com/zh/dashscope/)
- [æ‰¹é‡æ¨ç†APIæ–‡æ¡£](https://help.aliyun.com/zh/dashscope/developer-reference/batch-task)

---

## ğŸ¤ è´¡çŒ®ä¸åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤Issueæˆ–Pull Requestã€‚

**é¡¹ç›®ç»´æŠ¤è€…ï¼š** [æ‚¨çš„åå­—]  
**æœ€åæ›´æ–°ï¼š** 2026å¹´1æœˆ4æ—¥